<!DOCTYPE html>
<html>

<head>
    <script src="/external/phaser.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>

</head>

<body>

    <script>
        const socket = io();
        const screen_width = 1024;
        const screen_height = 640;
        const tile_size = 16;
        const tile_scale = 0.065;
        let last_update_received = {};

        const config = {
            type: Phaser.AUTO,
            width: screen_width,
            height: screen_height,
            scene: {
                preload: preload,
                create: create,
                update: updateState,
            }
        };

        var game = new Phaser.Game(config);
        var self;

        function preload() {
            self = this;
            this.load.image('tiles', 'assets/bg.png');
            this.load.image('plant1', 'assets/plants/shadow/1.png')
            this.load.image('plant2', 'assets/plants/shadow/2.png')
            this.load.image('plant3', 'assets/plants/shadow/3.png')
            this.load.image('player', 'assets/plants/shadow/45.png')

        }

        function getPlantScale(number_squares) {
            return tile_scale * number_squares
        }

        function create() {
            addBackground(tile_scale);
            // addPlant(5,5,'plant1',5)
            // addPlant(15,25,'plant2',4)
            // addPlant(7,15,'plant3',10)
        }

        function addPlant(x, y, asset_name, number_tiles) {
            scale = getPlantScale(number_tiles)
            const [w_size, w_half, h_size, h_half] = getAssetSize(asset_name, scale);
            addAsset(x, y, asset_name, scale, w_half, h_half)

        }
        function addBackground(scale) {
            const asset_name = 'tiles';
            const half_tile = tile_size / 2;

            for (let x = 0; x < screen_width / tile_size; x++) {
                for (let y = 0; y < screen_height / tile_size; y++) {
                    addAsset(x, y, asset_name, scale, half_tile, half_tile)
                }
            }

        }
        function getAssetSize(asset_name, scale) {
            const width = self.textures.get(asset_name).getSourceImage().width
            const height = self.textures.get(asset_name).getSourceImage().height
            const w_size = width * scale
            const w_half = w_size / 2
            const h_size = height * scale
            const h_half = h_size / 2
            return [w_size, w_half, h_size, h_half]
        }
        function addAsset(x, y, asset_name, scale, w_half, h_half) {
            const tile = self.add.image(w_half + tile_size * x, h_half + tile_size * y, asset_name);
            tile.setScale(scale);

        }

        function updateState() {
            if (!last_update_received) return;

            new_state = last_update_received;

            for (x in new_state.plants) {
                for (y in new_state.plants[x]) {
                    addPlant(x, y, new_state.plants[x][y].type, 2)
                }
            }
            for (i in new_state.players) {
                addPlant(new_state.players[i].pos_x, new_state.players[i].pos_y, "player", 3)
            }
        }

        socket.on('updateState', function (obj) {
            last_update_received = obj;
        });

    </script>

</body>

</html>